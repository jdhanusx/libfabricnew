
pipeline {
    agent any
    options {
        timestamps()
        timeout(activity: true, time: 4, unit: 'HOURS')
    }
    environment {
        JOB_CADENCE = 'PR'
    }

    stages {
        stage ('build-libfabric') {
            steps {
                withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin']) {
                sh """
                  python3.7 contrib/intel/jenkins/build.py 'libfabric' --ofi_build_mode='dbg'
                  python3.7 contrib/intel/jenkins/build.py 'libfabric'
                  python3.7 contrib/intel/jenkins/build.py 'libfabric' --ofi_build_mode='dl'
                  echo "libfabric build completed"
                 """
                }
            }
        }
        stage('build-fabtests') {
            steps {
                withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin']) {
                sh """
                python3.7 contrib/intel/jenkins/build.py 'fabtests' --ofi_build_mode='dbg'
                python3.7 contrib/intel/jenkins/build.py 'fabtests'
                python3.7 contrib/intel/jenkins/build.py 'fabtests' --ofi_build_mode='dl'
                echo 'fabtests build completed'
                """
                }
            }
        }

        stage('parallel-build') {
          parallel {
            stage ('build-SHMEM') {
                steps {
                  withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin']){
                    sh """
                    python3.7  contrib/intel/jenkins/build.py 'shmem' --ofi_build_mode='dbg'
                    python3.7  contrib/intel/jenkins/build.py 'shmem'
                    echo 'shmem benchmarks built successfully'
                    """
                  }
                }
            }
            stage('build-MPICH') {
                steps {
                  withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin']){
                    sh """
                    python3.7 contrib/intel/jenkins/build.py 'mpich_benchmarks' --ofi_build_mode='dbg'
                    python3.7 contrib/intel/jenkins/build.py 'mpich_benchmarks'
                    echo "mpi benchmarks with mpich - built successfully"
                    """
                  }
                }
            }
            stage('build-IMPI') {
                steps {
                  withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin']){
                    sh """
                    python3.7 contrib/intel/jenkins/build.py 'impi_benchmarks' --ofi_build_mode='dbg'
                    python3.7 contrib/intel/jenkins/build.py 'impi_benchmarks'
                    echo 'mpi benchmarks with impi - built successfully'
                    """
                  }
                }
            }
            stage ('build-OMPI') {
                steps {
                  withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin']){
                    sh """
                    python3.7 contrib/intel/jenkins/build.py 'ompi_benchmarks' --ofi_build_mode='dbg'
                    python3.7 contrib/intel/jenkins/build.py 'ompi_benchmarks'
                    echo 'mpi benchmarks with ompi - built successfully'
                    """
                  }
                }
            }
          }
        }

        stage('parallel-tests') {
            parallel {
                stage('tcp') {
                    agent {node {label 'eth'}}
                    steps{
                        withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin/:$PYTHONPATH'])
                        {
                          sh """
                            env
                            (
                                cd  ${env.WORKSPACE}/contrib/intel/jenkins/
                                python3.7 runtests.py --prov=tcp --ofi_build_mode='dbg' --test_mode='unit'
                                python3.7 runtests.py --prov=tcp --test_mode='unit'
                                python3.7 runtests.py --prov=tcp --test_mode='mpi'
                                python3.7 runtests.py --prov=sockets --test_mode='unit'
                            )
                          """
                        }
                     }
                }
                stage('udp') {
                     agent {node {label 'eth'}}
                     steps{
                        withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin/:$PYTHONPATH'])
                        {
                          sh """
                            env
                            (
                                cd  ${env.WORKSPACE}/contrib/intel/jenkins/
                                python3.7 runtests.py --prov=udp --ofi_build_mode='dbg' --test_mode='unit'
                                python3.7 runtests.py --prov=udp --test_mode='unit'
                            )
                          """
                        }
                     }
                }
                stage('shm') {
                     agent {node {label 'eth'}}
                     steps{
                        withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin/:$PYTHONPATH'])
                        {
                          sh """
                            env
                            (
                                cd  ${env.WORKSPACE}/contrib/intel/jenkins/
                                python3.7 runtests.py --prov=shm --ofi_build_mode='dbg' --test_mode='unit'
                                python3.7 runtests.py --prov=shm --test_mode='unit'
                            )
                          """
                        }
                     }
                }
                stage('verbs-rc') {
                     agent {node {label 'mlx5'}}
                     steps{
                        withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin:$PYTHONPATH']) {
                          sh """
                            env
                            (
                                cd ${env.WORKSPACE}/contrib/intel/jenkins/
                                python3.7 runtests.py --prov=verbs --ofi_build_mode='dbg' --test_mode='unit'
                                python3.7 runtests.py --prov=verbs --test_mode='unit'
                                python3.7 runtests.py --prov=verbs --test_mode='mpi'
                            )
                         """
                        }
                     }
                }
                stage('verbs-ud') {
                     agent {node {label 'mlx5'}}
                     steps{
                        withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin:$PYTHONPATH']) {
                          sh """
                            env
                            (
                                cd ${env.WORKSPACE}/contrib/intel/jenkins/
                                python3.7 runtests.py --prov=verbs --util=rxd --ofi_build_mode='dbg' --test_mode='unit'
                            )
                         """
                        }
                     }
                }
            }
      }
    }

    post {
        cleanup {
          withEnv(['PATH+EXTRA=/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin:$PYTHONPATH']) {
            sh "rm -rf '/mpibuilddir/mpich-build-dir/${env.JOB_NAME}/${env.BUILD_NUMBER}'"
            sh "rm -rf '/mpibuilddir/ompi-build-dir/${env.JOB_NAME}/${env.BUILD_NUMBER}'"
            sh "rm -rf '/mpibuilddir/mpich-suite-build-dir/${env.JOB_NAME}/${env.BUILD_NUMBER}'"
	          dir("${env.WORKSPACE}") {
              deleteDir()
            }
          }
        }
    }
}
