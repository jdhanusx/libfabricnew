%{!?configopts: %global configopts LDFLAGS=-Wl,--build-id}
%{!?provider: %define provider udp}
%{!?provider_formal: %define provider_formal udp}

# Define install_modulefile to 1 if you want this RPM to install a modulefile.
%{!?install_modulefile: %define install_modulefile 0}

# Define install_default_module_version to 1 if you want this RPM to install a .version file
%{!?install_default_module_version: %define install_default_module_version 0}

# Path to install modulefiles in
%{!?modulefile_path: %define modulefile_path /usr/share/Modules/modulefiles}

Name: lib%{provider}-fi
Version: @VERSION@
Release: 1%{?dist}
Summary: Dynamic %{provider_formal} provider for libfabric

Group: System Environment/Libraries
License: GPLv2 or BSD
Url: http://www.github.com/ofiwg/libfabric
Source: http://www.github.org/ofiwg/%{name}/releases/download/%{provider}-v{%version}/%{name}-%{version}.tar.bz2
BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)
# Requires: libfabric
# BuildRequires: libfabric
%if 0%{?suse_version} >= 1
Provides: lib%{provider}-fi1 = %{version}-%{release}
%endif

%description
This RPM provides the %{provider_formal} provider as a "plugin" to an existing
libfabric installation.  This plugin will override older %{provider_formal}
provider functionality in the existing libfabric installation.

%prep
%setup -q -n %{name}-%{version}

%build
%configure %{configopts}
make %{?_smp_mflags}

%install
rm -rf %{buildroot}

# First, the [optional] modulefile

%if %{install_modulefile}
%{__mkdir_p} %{buildroot}/%{modulefile_path}/%{name}/
cat <<EOF >%{buildroot}/%{modulefile_path}/%{name}/%{version}
#%Module -*- tcl -*-
#
# This file was automatically generated by libudp-fi RPM.
#
# Modulefile for libudp-fi %{version}
#

proc ModulesHelp { } {
   puts stderr \"\tThis module adds libudp-fi %{version} to the environment.\"
}

module-whatis   \"This module adds libudp-fi %{version} to the environment\"

prepend-path LD_LIBRARY_PATH %{_libdir}
prepend-path MANPATH %{_mandir}
prepend-path PKG_CONFIG_PATH %{_libdir}/pkgconfig
EOF
%if %{install_default_module_version}
cat <<EOF >%{buildroot}/%{modulefile_path}/%{name}/.version
#%Module1.0
##
set ModulesVersion "%{version}"
EOF
%endif
%endif

%makeinstall installdirs
# remove unpackaged files from the buildroot
rm -f %{buildroot}%{_libdir}/*.la

%clean
rm -rf %{buildroot}

%post -p /sbin/ldconfig
%postun -p /sbin/ldconfig

%files
%defattr(-,root,root,-)
%{_libdir}/lib*.so.*
%dir %{_libdir}/%{name}/
%doc README
%exclude %{_libdir}/*.a
%exclude %{_libdir}/*.la
%exclude %{_libdir}/pkgconfig

%changelog
* Wed Aug 12 2020 libfabric <ofiwg@lists.openfabrics.org> initial udp spec file
- First release of specfile for packaging DL provider